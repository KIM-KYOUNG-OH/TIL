# 목차

- 요구사항 분석
- 도메인 모델과 테이블 설계
- 에니티 클래스 개발
- 엔티티 설계시 주의점

# 요구사항 분석

- 회원 기능
    - 회원 등록
    - 회원 조회
- 상품 기능
    - 상품 등록
    - 상품 수정
    - 상품 조회
- 주문 기능
    - 상품 주문
    - 주문 내역 조회
    - 주문 취소
- 기타 요구사항
    - 상품은 재고 관리가 필요하다
    - 상품의 종류는 도서, 음반, 영화가 있다.
    - 상품을 카테고리로 구분할 수 있다.
    - 상품 주문시 배송 정보를 입력할 수 있다.

# 도메인 모델

<img width="800" alt="스크린샷 2022-01-09 오후 6 29 12" src="https://user-images.githubusercontent.com/66231761/148676794-8637371b-a933-4bbc-942e-77c9532db1a1.png">

# 엔티티 분석

<img width="800" alt="스크린샷 2022-01-09 오후 6 29 33" src="https://user-images.githubusercontent.com/66231761/148676800-07b4fff5-30da-47eb-ad2d-e65a567ace80.png">

- 설계단계에서 양단방향보단 단방향 연관관계를 사용하는 것이 좋다.
- 다대다 관계는 운영에서 쓰면 안됨!!

# 테이블 분석

<img width="800" alt="스크린샷 2022-01-09 오후 6 30 00" src="https://user-images.githubusercontent.com/66231761/148676812-aa13b8f4-ccba-44bd-9046-8f2d58480c16.png">

- Single Table 전략
    - TYPE으로 여러 하위클래스를 single table로 통합하는 전략
- 관계형 데이터베이스는 Column의 타입을 list로 가질 수 없기 때문에 다대다 연관관계에서는 두 테이블 사이에 메핑 테이블을 하나더 둔다.
- 연관관계 주인 정하기
    - 일대다에서 다쪽에 FK를 두고 연관관계 주인으로 삼는다.
    - 반대쪽은 단순히 조회용으로 만 쓴다.
    - 위의 원칙을 지키지 않으면 유지보수가 어려워짐

# 엔티티 클래스 개발

- 1대1관계에서는 더 자주 조회 요청을 수행하는 테이블에 FK를 둔다.
- Setter를 만들지 않는 이유
    - 객체의 데이터 변경 시점을 알기위해서 코드를 뒤져야 함
    - 유지보수성 감소, 캡슐화 위반
- 실무에선 단순 “id”보단 관례상 “테이블명_id”이 더 추적하기 편함
- 값 타입
    - getter만 제공
    - immutable하도록 설계
    - 생성자에서 값을 모두 초기화하도록 하자
    - protected의 기본 생성자를 만들자

# 엔티티 설계시 주의점

- 엔티티에는 가급적 setter를 사용하지 말자
    - 변경 포인트가 너무 많아서 유지보수가 어렵다.
    - 예제에선 쉽게하려고 setter를 열어둠
- 모든 연관관계는 지연로딩으로 설정해야한다!!(LAZY)
    - 즉시로딩은 예측이 어렵고 어떤 SQL이 실행될지 추적하기 어렵다.
    - JPQL을 실행할 때 N+1 문제가 자주 발생한다.
    - fetch join 또는 엔티티 그래프 기능을 사용한다.
    - @XToOne은 default가 즉시로딩이므로 지연로딩으로 변경해줘야 함
- 컬렉션 타입 필드는 바로 초기화하는 것이 안전하다.
    - Null 문제에서 안전
    - 하이버네이트는 엔티티를 영속화할 때 컬렉션을 감싸서 하이버네이트가 제공하는 내장 컬렉션으로 변경한다.
- 테이블, 컬럼명 생성 전략
    - SpringPhysicalNamingStrategy
        - camelCase → underscore 스타일로 바꿈
- cascade
    - 객체 생성과 삭제를 전파
- 연관관계 매핑 편의 메서드
    - 양방향 연관관계시 하나의 메서드로 원자적으로 양쪽 관계를 매핑하는 메서드

# 심화

- @Inheritance
- @DiscriminatorColumn
- @Embedded
- 실무에선 다대다 관계를 사용하지 말자
- JPA 리플렉션
- find in files 단축키: command + shift + f
