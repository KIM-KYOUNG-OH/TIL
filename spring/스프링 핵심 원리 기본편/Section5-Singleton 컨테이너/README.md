# 웹 애플리케이션과 싱글톤

- 대부분의 웹 애플리케이션은 여러 고객들이 동시에 요청을 한다.

    ![스크린샷 2021-12-28 오전 2 06 50](https://user-images.githubusercontent.com/66231761/147492833-df1a4069-d880-4c8b-9954-2bf7c005c32d.png)

- 스프링 없는 순수 DI 컨테이너는 고객의 요청 때마다 객체를 새로 생성한다.
- 즉, 고객 트래픽이 초당 100이 나오면 초당 100개의 객체가 생성되고 소멸된다. → 메모리 낭비
- 해결방안은 해당 객체를 딱 1개만 생성하고 공유하도록 설계하는 것이다. → 싱글톤 패턴

# 싱글톤 패턴

- 클래스의 인스턴스가 메모리에 딱 1개만 생성되는 것을 보장하는 디자인 패턴이다.
- 객체 인스턴스를 2개 이상 생성하지 못하도록 막아야 함

```java
public class SingletonService {

    private static final SingletonService instance = new SingletonService();  // 자기 자신을 클래스 내부에 가짐

    public static SingletonService getInstance() {
        return instance;
    }  // 조회 메서드

    private SingletonService() {}  // 기본 생성자를 private으로 선언

    public void logic() {
        System.out.println("싱글톤 객체 로직 호출");
    }
}
```

- 싱글톤 패턴을 구현하는 방법은 여러가지가 있다.

# 싱글톤 패턴의 단점

- 코드 자체가 많이 들어간다.
- 의존관계상 클라이언트가 구체 클래스에 의존한다. → DIP 위반
- 클라이언트가 구체 클래스에 의존해서 OCP 위반
- 테스트가 어렵다
- 내부 속성을 변경하거나 초기화하기 어렵다.
- 유연성이 떨어짐
- 안티패턴으로 불리기도 함

# 싱글톤 컨테이너

- 스프링 컨테이너는 싱글톤 패턴을 적용하지 않아도 객체 인스턴스를 싱글톤으로 관리한다.
- 스프링 컨테이너는 싱글톤 컨테이너, 싱글톤 레지스트리 역할을 한다.
    - 싱글톤 레지스트리는 싱글톤 객체를 생성하고 관리하는 기능을 말함
- 싱글톤 패턴의 단점을 모두 해결하면서 객체를 싱글톤으로 유지할 수 있다.

![스크린샷 2021-12-28 오전 2 07 15](https://user-images.githubusercontent.com/66231761/147492859-67574926-fda3-484a-8937-3c2bfe17cacc.png)

- 싱글톤 컨테이너를 사용하면, 기존의 고객의 요청때마다 객체를 생성하는 것이 아니라 이미 만들어진 객체를 공유해서 효율적으로 재사용할 수 있다.
- 싱글톤 방식 말고도 새로운 객체를 생성해서 반환하는 기능도 제공한다.

# 싱글톤 방식의 주의점

- 객체 인스턴스를 하나만 생성해서 공유하는 방식은 여러 클라이언트가 하나의 객체 인스턴스를 공유하기 때문에 해당 객체는 stateful(상태를 유지)하게 설계하면 안된다.
- 즉, stateless(무상태)로 설계해야 한다.
    - 특정 클라이언트에 의존적인 필드가 있으면 안된다.
    - 특정 클라이언트가 값을 변경할 수 있는 필드가 있으면 안된다.
    - 가급적 readOnly로 설계
    - 필드대신 자바에서 공유되지 않는 지역변수, 파라미터, ThreadLocal 등에서 사용해야 한다.
- 실무의 복잡한 상황에서 Race Condition 에러를 찾기 힘들다.

---

# @Configuration

- 사실 싱글톤을 위해서 존재함
- AppConfig.class 에서 같은 객체를 여러번 생성했는데 싱글톤인지 의심이 간다.

# @Configuration과 바이트코드 조작의 마법

- 스프링 컨테이너는 싱글톤 레지스트리이다.

![스크린샷 2021-12-28 오전 2 07 33](https://user-images.githubusercontent.com/66231761/147492879-7617e843-55e5-4263-9631-dc37afb915d2.png)

- spring이 바이트코드 조작 라이브러리를 사용해서 AppConfig 클래스를 상속받은 임의의 다른 클래스를 만들고 빈으로 등록한다.
- AppConfig의 메서드를 최초 한번만 호출하고 singleton인 AppConfig@CGLIB를 빈으로 등록
- 이미 스프링 컨테이너에 등록된 인스턴스를 호출하면 이미 생성된 인스턴스를 반환한다.
- @Configuration가 AppConfig@CGLIB를 생성하는 역할을 함, 즉 싱글톤을 제공하는 핵심
- 따라서 설정 정보에는 @Configuration을 꼭 추가하자

# 심화

- TPS(Transaction per Section): 초당 트랜잭션 수
